<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ë–ª–æ–∫–Ω–æ—Ç</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #121212;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      padding: 5px;
      gap: 5px;
      background: #1e1e1e;
      justify-content: space-between;
    }
    button, select, input[type="color"] {
      padding: 5px;
      font-size: 14px;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
    }
    #editorWrapper {
      flex: 1;
      display: flex;
    }
    .CodeMirror {
      flex: 1;
      height: 100%;
    }
    #drawCanvas {
      position: fixed;
      top: 0;
      left: 0;
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="newFile()">‚ûï –ù–æ–≤–∏–π</button>
    <button onclick="saveCurrent()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button onclick="document.getElementById('fileInput').click()">üìÇ –í—ñ–¥–∫—Ä–∏—Ç–∏</button>
    <button onclick="showFileManager()">üìÅ –ú–µ–Ω–µ–¥–∂–µ—Ä</button>
    <button onclick="openImageBackground()">üñºÔ∏è –§–æ–Ω</button>
    <button onclick="runCode()">üöÄ HTML</button>
    <button onclick="toggleDraw()">‚úèÔ∏è –ú–∞–ª—é–≤–∞—Ç–∏</button>
    <input type="color" id="colorPicker" value="#00ffff" style="display:none">
    <button id="clearBtn" onclick="clearCanvas()" style="display:none">üßπ –û—á–∏—Å—Ç–∏—Ç–∏</button>
    <button onclick="saveDrawing()" id="saveDrawBtn" style="display:none">üßæ –ó–±–µ—Ä–µ–≥—Ç–∏ –º–∞–ª—é–Ω–æ–∫</button>
    <input type="file" id="fileInput" accept=".txt" style="display:none" />
  </div>

  <div id="editorWrapper">
    <textarea id="editor"></textarea>
  </div>
  <canvas id="drawCanvas"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/html-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/css-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/javascript-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

  <script>
    const editorExtraKeys = {
      "Ctrl-Space": "autocomplete",
      "'" : (cm) => {
        cm.replaceSelection("''");
        cm.execCommand("goCharLeft");
      },
      '"' : (cm) => {
        cm.replaceSelection('""');
        cm.execCommand("goCharLeft");
      },
      '(': (cm) => {
        cm.replaceSelection("()");
        cm.execCommand("goCharLeft");
      },
      '[': (cm) => {
        cm.replaceSelection("[]");
        cm.execCommand("goCharLeft");
      },
      '{': (cm) => {
        cm.replaceSelection("{}");
        cm.execCommand("goCharLeft");
      }
    };

    let currentFile = null;
    let editor;

    window.onload = () => {
      editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode: "htmlmixed",
        theme: "dracula",
        lineNumbers: true,
        lineWrapping: true,
        autoCloseTags: true,
        autoCloseBrackets: true,
        extraKeys: editorExtraKeys
      });

      editor.on("inputRead", function(cm, change) {
        if (change.text[0].match(/[\w<\"\']/)) {
          cm.showHint();
        }
      });

      const savedFiles = JSON.parse(localStorage.getItem('notepadFiles') || '{}');
      const lastOpened = localStorage.getItem('lastOpenedFile');

      if (lastOpened && savedFiles[lastOpened]) {
        openFile(lastOpened);
      } else if (Object.keys(savedFiles).length > 0) {
        openFile(Object.keys(savedFiles)[0]);
      } else {
        newFile();
      }
    };

    function newFile() {
      editor.setValue("");
      currentFile = `file_${Date.now()}`;
    }

    function saveCurrent() {
      const files = JSON.parse(localStorage.getItem('notepadFiles') || '{}');
      files[currentFile] = editor.getValue();
      localStorage.setItem('notepadFiles', JSON.stringify(files));
      localStorage.setItem('lastOpenedFile', currentFile);
    }

    function openFile(name) {
      const files = JSON.parse(localStorage.getItem('notepadFiles') || '{}');
      if (files[name]) {
        editor.setValue(files[name]);
        currentFile = name;
        localStorage.setItem('lastOpenedFile', name);
      }
    }

    function showFileManager() {
      const files = JSON.parse(localStorage.getItem('notepadFiles') || '{}');
      const names = Object.keys(files);
      if (!names.length) return alert("–§–∞–π–ª—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
      const choice = prompt("–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª:\n" + names.join("\n"));
      if (choice && files[choice]) openFile(choice);
    }

    function runCode() {
      const win = window.open();
      win.document.write(editor.getValue());
    }

    function openImageBackground() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => {
            document.querySelector(".CodeMirror").style.backgroundImage = `url('${reader.result}')`;
            document.querySelector(".CodeMirror").style.backgroundSize = 'cover';
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function saveDrawing() {
      const canvas = document.getElementById("drawCanvas");
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "drawing.png";
      link.click();
    }

    function toggleDraw() {
      const canvas = document.getElementById("drawCanvas");
      if (canvas.style.display === "none") {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.style.display = "block";
        document.getElementById("clearBtn").style.display = "inline-block";
        document.getElementById("colorPicker").style.display = "inline-block";
        document.getElementById("saveDrawBtn").style.display = "inline-block";
        enableDrawing();
      } else {
        canvas.style.display = "none";
        document.getElementById("clearBtn").style.display = "none";
        document.getElementById("colorPicker").style.display = "none";
        document.getElementById("saveDrawBtn").style.display = "none";
        disableDrawing();
      }
    }

    let isDrawing = false;
    let drawCtx;
    let lastX = 0, lastY = 0;

    function enableDrawing() {
      const canvas = document.getElementById("drawCanvas");
      drawCtx = canvas.getContext("2d");
      drawCtx.lineWidth = 2;
      drawCtx.lineCap = "round";
      drawCtx.strokeStyle = document.getElementById("colorPicker").value;

      canvas.addEventListener("mousedown", startDraw);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", endDraw);
      canvas.addEventListener("mouseout", endDraw);

      document.getElementById("colorPicker").addEventListener("change", function() {
        drawCtx.strokeStyle = this.value;
      });
    }

    function disableDrawing() {
      const canvas = document.getElementById("drawCanvas");
      canvas.removeEventListener("mousedown", startDraw);
      canvas.removeEventListener("mousemove", draw);
      canvas.removeEventListener("mouseup", endDraw);
      canvas.removeEventListener("mouseout", endDraw);
    }

    function startDraw(e) {
      isDrawing = true;
      [lastX, lastY] = [e.clientX, e.clientY];
    }

    function draw(e) {
      if (!isDrawing) return;
      drawCtx.beginPath();
      drawCtx.moveTo(lastX, lastY);
      drawCtx.lineTo(e.clientX, e.clientY);
      drawCtx.stroke();
      [lastX, lastY] = [e.clientX, e.clientY];
    }

    function endDraw() {
      isDrawing = false;
    }

    function clearCanvas() {
      const canvas = document.getElementById("drawCanvas");
      drawCtx.clearRect(0, 0, canvas.width, canvas.height);
    }
  </script>
</body>
</html>
